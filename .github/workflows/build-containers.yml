name: Build and Test Containers

# Este workflow valida que los contenedores se construyen correctamente
# Usa Docker (disponible en GitHub Actions) para builds, pero los comandos
# son compatibles con Podman

on:
  pull_request:
    branches: [ main, development ]
    paths:
      - 'backend/**'
      - 'rag_service/**'
      - 'docker-compose.yml'
      - '**/Dockerfile'
  push:
    branches: [ main, development ]
    paths:
      - 'backend/**'
      - 'rag_service/**'
      - 'docker-compose.yml'
      - '**/Dockerfile'

jobs:
  build-backend:
    name: Build Backend Container
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./backend/Dockerfile
          push: false
          load: true
          tags: tfg-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            INSTALL_DEV=true

      - name: Test backend image can run
        run: |
          docker run --rm -d --name backend-test \
            -e GEMINI_API_KEY=test \
            -e LLM_PROVIDER=gemini \
            tfg-backend:test
          sleep 5
          docker logs backend-test
          docker stop backend-test || true

  build-rag-service:
    name: Build RAG Service Container
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build rag_service image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./rag_service/Dockerfile
          push: false
          load: true
          tags: rag-service:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            INSTALL_DEV=true

      - name: Test rag_service image can run
        run: |
          docker run --rm -d --name rag-test \
            -e QDRANT_HOST=localhost \
            -e OLLAMA_HOST=localhost \
            rag-service:test
          sleep 5
          docker logs rag-test
          docker stop rag-test || true

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-backend, build-rag-service]
    if: always()
    steps:
      - name: Check build results
        run: |
          if [[ "${{ needs.build-backend.result }}" == "failure" ]] || \
             [[ "${{ needs.build-rag-service.result }}" == "failure" ]]; then
            echo "❌ Some container builds failed"
            exit 1
          else
            echo "✅ All containers built successfully"
          fi
