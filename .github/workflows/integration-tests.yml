name: Integration Tests

# Este workflow ejecuta tests de integración end-to-end
# Requiere todos los servicios corriendo
# Se ejecuta manualmente o en schedule para evitar costos de CI

on:
  workflow_dispatch:
  schedule:
    # Ejecutar cada noche a las 3 AM UTC (después de infrastructure tests)
    - cron: '0 3 * * *'
  pull_request:
    branches: [ main, development ]
    # Solo ejecutar en PRs que toquen código crítico
    paths:
      - 'backend/logic/**'
      - 'backend/api.py'
      - 'rag_service/api.py'
      - 'rag_service/routes/**'

jobs:
  integration-tests:
    name: Integration Tests (Full Stack)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    env:
      MONGO_ROOT_USERNAME: testuser
      MONGO_ROOT_PASSWORD: testpass
      MONGO_HOSTNAME: mongo
      MONGO_PORT: 27017
      MONGO_AUTH_DB: admin
      MONGO_EXPRESS_BASICAUTH_ENABLED: "false"
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      OLLAMA_HOST: ollama
      OLLAMA_PORT: 11434
      RAG_SERVICE_URL: http://rag_service:8081
      LLM_PROVIDER: gemini
      INSTALL_DEV: "true"

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          # Instalar dependencias del proyecto raíz (incluye LangChain y todas las deps)
          pip install -e ".[dev]"

      - name: Create .env file
        run: |
          cat > .env << EOF
          MONGO_ROOT_USERNAME=${MONGO_ROOT_USERNAME}
          MONGO_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
          MONGO_HOSTNAME=${MONGO_HOSTNAME}
          MONGO_PORT=${MONGO_PORT}
          MONGO_AUTH_DB=${MONGO_AUTH_DB}
          MONGO_EXPRESS_BASICAUTH_ENABLED=${MONGO_EXPRESS_BASICAUTH_ENABLED}
          QDRANT_HOST=${QDRANT_HOST}
          QDRANT_PORT=${QDRANT_PORT}
          OLLAMA_HOST=${OLLAMA_HOST}
          OLLAMA_PORT=${OLLAMA_PORT}
          RAG_SERVICE_URL=${RAG_SERVICE_URL}
          LLM_PROVIDER=${LLM_PROVIDER}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          INSTALL_DEV=${INSTALL_DEV}
          EOF

      - name: Start all services
        run: |
          docker compose up -d
          echo "Services started, waiting for readiness..."

      - name: Wait for all services to be healthy
        run: |
          # MongoDB
          timeout 60 bash -c 'until docker compose exec -T mongo mongosh --eval "db.runCommand({ ping: 1 })" > /dev/null 2>&1; do sleep 2; done'
          echo "✅ MongoDB ready"
          
          # Qdrant
          timeout 60 bash -c 'until curl -s http://localhost:6333/health > /dev/null; do sleep 2; done'
          echo "✅ Qdrant ready"
          
          # Ollama
          timeout 60 bash -c 'until curl -s http://localhost:11435/api/version > /dev/null; do sleep 2; done'
          docker compose exec -T ollama ollama pull nomic-embed-text
          echo "✅ Ollama ready"
          
          # RAG Service
          timeout 120 bash -c 'until curl -s http://localhost:8081/health > /dev/null; do sleep 3; done'
          echo "✅ RAG Service ready"
          
          # Backend
          timeout 120 bash -c 'until curl -s http://localhost:8080/health > /dev/null; do sleep 3; done'
          echo "✅ Backend ready"

      - name: Run integration tests
        run: |
          pytest tests/integration/ -m integration -v --tb=short --maxfail=3
        env:
          API_BASE_URL: http://localhost:8080
          RAG_BASE_URL: http://localhost:8081
          API_TIMEOUT: 90

      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== Backend Logs (last 100 lines) ==="
          docker compose logs --tail=100 backend
          echo ""
          echo "=== RAG Service Logs (last 100 lines) ==="
          docker compose logs --tail=100 rag_service

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
          docker system prune -af --volumes

  integration-summary:
    name: Integration Tests Summary
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: always()
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
            echo "❌ Integration tests failed"
            exit 1
          elif [[ "${{ needs.integration-tests.result }}" == "success" ]]; then
            echo "✅ Integration tests passed"
          else
            echo "⚠️ Integration tests were skipped or cancelled"
          fi
