name: Manual Release

# Workflow para crear releases manualmente desde GitHub UI
# MÃ¡s simple y directo que Release Please - para control total

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'
      
      release_notes:
        description: 'Release notes (optional - will auto-generate if empty)'
        required: false
        type: string
      
      prerelease:
        description: 'Mark as pre-release?'
        required: false
        type: boolean
        default: false
      
      skip_tests:
        description: 'Skip tests (not recommended)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write

jobs:
  validate:
    name: Validate Before Release
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run linting
        run: |
          ruff check .
          black --check .
          isort --check-only .
      
      - name: Run unit tests
        run: |
          cd backend && pytest -m "not integration" --tb=short
          cd ../rag_service && pytest -m "not integration" --tb=short
      
      - name: Verify Docker builds
        run: |
          docker build -t backend:test ./backend
          docker build -t rag_service:test ./rag_service

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate]
    if: always() && (needs.validate.result == 'success' || needs.validate.result == 'skipped')
    
    outputs:
      version: ${{ steps.bump.outputs.version }}
      tag: ${{ steps.bump.outputs.tag }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Bump version
        id: bump
        run: |
          # Usar el script existente para bump version
          NEW_VERSION=$(python3 scripts/bump_version.py --part ${{ inputs.version_bump }})
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version bumped to $NEW_VERSION"
      
      - name: Generate changelog entry
        id: changelog
        run: |
          VERSION="${{ steps.bump.outputs.version }}"
          TAG="v$VERSION"
          DATE=$(date +%Y-%m-%d)
          
          # Obtener Ãºltimo tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          # Generar changelog desde commits
          echo "## [$VERSION] - $DATE" > release_notes.md
          echo "" >> release_notes.md
          
          if [ -n "$LAST_TAG" ]; then
            # Agrupar commits por tipo usando conventional commits
            echo "### Added" >> release_notes.md
            git log $LAST_TAG..HEAD --pretty=format:"- %s" --grep="^feat" | sed 's/^feat[:(].*[):]*//' >> release_notes.md || echo "" >> release_notes.md
            echo "" >> release_notes.md
            
            echo "### Fixed" >> release_notes.md
            git log $LAST_TAG..HEAD --pretty=format:"- %s" --grep="^fix" | sed 's/^fix[:(].*[):]*//' >> release_notes.md || echo "" >> release_notes.md
            echo "" >> release_notes.md
            
            echo "### Changed" >> release_notes.md
            git log $LAST_TAG..HEAD --pretty=format:"- %s" --grep="^chore\|^refactor\|^perf" | sed 's/^[a-z]*[:(].*[):]*//' >> release_notes.md || echo "" >> release_notes.md
            echo "" >> release_notes.md
          else
            echo "- Initial release" >> release_notes.md
          fi
          
          # Usar release notes customizadas si se proporcionaron
          if [ -n "${{ inputs.release_notes }}" ]; then
            echo "" >> release_notes.md
            echo "### Additional Notes" >> release_notes.md
            echo "${{ inputs.release_notes }}" >> release_notes.md
          fi
          
          cat release_notes.md
      
      - name: Update CHANGELOG.md
        run: |
          # Insertar el nuevo entry despuÃ©s de ## [Unreleased]
          VERSION="${{ steps.bump.outputs.version }}"
          
          # Crear backup
          cp CHANGELOG.md CHANGELOG.md.bak
          
          # Insertar nuevo entry
          awk -v new="$(cat release_notes.md)" '
            /## \[Unreleased\]/ {
              print $0
              print ""
              print new
              next
            }
            {print}
          ' CHANGELOG.md.bak > CHANGELOG.md
          
          rm CHANGELOG.md.bak
      
      - name: Commit and tag
        run: |
          VERSION="${{ steps.bump.outputs.version }}"
          TAG="v$VERSION"
          
          git add pyproject.toml CHANGELOG.md
          git commit -m "chore(release): $VERSION"
          git tag -a "$TAG" -m "Release $TAG"
          
          git push origin main
          git push origin "$TAG"
      
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.bump.outputs.tag }}"
          PRERELEASE=""
          if [ "${{ inputs.prerelease }}" = "true" ]; then
            PRERELEASE="--prerelease"
          fi
          
          gh release create "$TAG" \
            --title "Release $TAG" \
            --notes-file release_notes.md \
            $PRERELEASE

  build-containers:
    name: Build and Publish Docker Images
    needs: [create-release]
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [backend, rag_service]
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-release.outputs.tag }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/${{ matrix.service }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.create-release.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.create-release.outputs.version }}
            type=raw,value=latest
      
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.create-release.outputs.version }}
      
      - name: Update release with container info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.create-release.outputs.tag }}"
          
          gh release edit "$TAG" --notes-file <(cat <<EOF
          $(gh release view "$TAG" --json body -q .body)
          
          ## ðŸ“¦ Docker Images
          
          ### ${{ matrix.service }}
          \`\`\`bash
          docker pull ghcr.io/${{ github.repository }}/${{ matrix.service }}:${{ needs.create-release.outputs.version }}
          \`\`\`
          
          [View on GitHub Container Registry](https://github.com/${{ github.repository }}/pkgs/container/${{ matrix.service }})
          EOF
          )

  release-summary:
    name: Release Summary
    needs: [create-release, build-containers]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸš€ Release Created Successfully
          
          ## Release Details
          
          - **Version**: ${{ needs.create-release.outputs.version }}
          - **Tag**: ${{ needs.create-release.outputs.tag }}
          - **Type**: ${{ inputs.prerelease && 'Pre-release' || 'Stable Release' }}
          
          ## ðŸ“¦ Published Artifacts
          
          ### Docker Images
          
          #### Backend
          ```bash
          docker pull ghcr.io/${{ github.repository }}/backend:${{ needs.create-release.outputs.version }}
          ```
          
          #### RAG Service
          ```bash
          docker pull ghcr.io/${{ github.repository }}/rag_service:${{ needs.create-release.outputs.version }}
          ```
          
          ## ðŸ”— Links
          
          - [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.tag }})
          - [View Backend Container](https://github.com/${{ github.repository }}/pkgs/container/backend)
          - [View RAG Service Container](https://github.com/${{ github.repository }}/pkgs/container/rag_service)
          
          ## ðŸ“ Next Steps
          
          1. Update deployment configurations to use new version
          2. Announce release to team/users
          3. Monitor for issues
          4. Update documentation if needed
          
          EOF
